{{ $imageOptimization := site.Store.Get "imageOptimization" }}

{{ $useDefault := false }}
{{ $featured := "" }}
{{ $featuredURL := "" }}
{{ with .Params.pageFeatureImage }}
	{{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
		{{ if site.Params.imageHotlink }}
			{{ $featuredURL = . }}
		{{ else }}
			{{ $featured = resources.GetRemote . }}
		{{ end }}
	{{ else }}
		{{ $featured = resources.Get . }}
	{{ end }}
{{ end }}

{{ if not (or $featured $featuredURL) }}
	{{ $images := .Resources.ByType "image" }}
	{{ range slice "feature*" }}
		{{ if not $featured }}{{ $featured = $images.GetMatch . }}{{ end }}
	{{ end }}
{{ end }}

{{ if not (or $featured $featuredURL) }}
	{{ $default := site.Store.Get "imageFeatured" }}
	{{ if $default.url }}
		{{ $featuredURL = $default.url }}
		{{ $useDefault = true }}
	{{ else if $default.obj }}
		{{ $featured = $default.obj }}
		{{ $useDefault = true }}
	{{ end }}
{{ end }}

{{/* generate image URL if not hotlink */}}
{{ if not $featuredURL }}
	{{ with $featured }}
		{{ $featuredURL = .RelPermalink }}
		{{ if not (eq .MediaType.SubType "svg") }}
			{{ if gt .Width 1200 }}
				{{ $featuredURL = (.Resize "1200x webp lossy").RelPermalink }}
			{{ end }}
		{{ end }}
	{{ end }}
{{ end }}

{{ .Store.Set "featured" $featured }}
{{ .Store.Set "featuredURL" $featuredURL }}
{{ .Store.Set "featuredUseDefault" $useDefault }}

{{ if $featuredURL }}
	{{ if eq (.Param "pageHeroStyle") "disable" }}
		{{- /**/ -}}
	{{ else if eq (.Param "pageHeroStyle") "custom" }}
		{{ partial "page/hero/custom.html" . }}
	{{ else if eq (.Param "pageHeroStyle") "background" }}
		{{ partial "page/hero/background.html" . }}
	{{ else if eq (.Param "pageHeroStyle") "big" }}
		{{ partial "page/hero/big.html" . }}
	{{ end }}
{{ end }}
