{{ $shouldResize := site.Params.imageOptimizationMD | default false }}
{{- $url := urls.Parse (.Get "src") }}
{{- $altText := .Get "alt" }}
{{- $caption := .Get "caption" }}
{{- $href := .Get "href" }}
{{- $class := .Get "class" }}
{{- $target := .Get "target" | default "_blank" }}

<figure>
{{- with $href }}<a href="{{ . }}" {{ with $target }}target="{{ . }}"{{ end }} class="inline-block">{{ end -}}
{{- if findRE "^https?" $url.Scheme }}
		<img class="{{ with $class }} {{ . }}{{ end }}{{ if $href }} m-0!{{ end }}" src="{{ $url.String }}" alt="{{ $altText }}" />
{{- else }}
	{{- $resource := "" }}
	{{- if $.Page.Resources.GetMatch ($url.String) }}
		{{- $resource = $.Page.Resources.GetMatch ($url.String) }}
	{{- else if resources.GetMatch ($url.String) }}
		{{- $resource = resources.Get ($url.String) }}
	{{- end }}
	{{- with $resource }}
		{{- if and $shouldResize (not (eq .MediaType.SubType "svg")) }}
			<img
				class="{{ with $class }} {{ . }}{{ end }}{{ if $href }} m-0!{{ end }}"
				loading="lazy"
				decoding="async"
				fetchpriority="auto"
				alt="{{ $altText }}"
				{{ with .Width }}width="{{ . }}"{{ end }}
				{{ with .Height }}height="{{ . }}"{{ end }}
				src="{{ .RelPermalink }}"
				srcset="
				{{- (.Resize "800x webp lossy").RelPermalink }} 800w,
				{{- (.Resize "1280x webp lossy").RelPermalink }} 1280w"
				sizes="(min-width: 768px) 50vw, 65vw"
				data-zoom-src="{{ .RelPermalink }}"
			/>
		{{- else }}
			<img
				class="{{ with $class }} {{ . }}{{ end }}{{ if $href }} m-0!{{ end }}"
				src="{{ .RelPermalink }}"
				{{ with .Width }}width="{{ . }}"{{ end }}
				{{ with .Height }}height="{{ . }}"{{ end }}
				alt="{{ $altText }}"
			/>
		{{- end }}
	{{- else }}
		<img class="{{ with $class }} {{ . }}{{ end }}{{ if $href }} m-0!{{ end }}" src="{{ $url.String }}" alt="{{ $altText }}" />
	{{- end }}
{{- end }}
{{ if $href }}</a>{{ end }}
{{ with $caption }}<figcaption>{{ . | markdownify }}</figcaption>{{ end }}
</figure>

